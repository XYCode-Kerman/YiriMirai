<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>mirai.bus API documentation</title>
<meta name="description" content="此模块提供基础事件总线相关。 …" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>mirai.bus</code></h1>
</header>
<section id="section-intro">
<p>此模块提供基础事件总线相关。</p>
<p>此处的事件总线不包含 model 层封装。包含 model 层封装的版本，请参见模块 <code><a title="mirai.models.bus" href="models/bus.html">mirai.models.bus</a></code>。</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python"># -*- coding: utf-8 -*-
&#34;&#34;&#34;
此模块提供基础事件总线相关。

此处的事件总线不包含 model 层封装。包含 model 层封装的版本，请参见模块 `mirai.models.bus`。
&#34;&#34;&#34;
import abc
import asyncio
import inspect
import logging
from collections import defaultdict
from typing import Any, Awaitable, Callable, Dict, Iterable, List, Optional

from mirai.exceptions import SkipExecution, StopExecution, StopPropagation
from mirai.utils import PriorityDict, async_with_exception

logger = logging.getLogger(__name__)


def event_chain_separator(sep: str = &#39;.&#39;):
    &#34;&#34;&#34;按照分隔符划分事件链，默认按点号划分。

    例如使用 `event_chain_separator(&#39;.&#39;)` 时，
    `&#34;Event.MyEvent&#34;` 所在事件链为 `[&#34;Event.MyEvent&#34;, &#34;Event&#34;]`。&#34;&#34;&#34;
    def generator(event: str):
        while True:
            yield event
            event, *sub_event = event.rsplit(sep, maxsplit=1)  # 由下到上依次触发
            if not sub_event:  # 顶层事件触发完成
                break

    return generator


def event_chain_single(event: str):
    &#34;&#34;&#34;只包含单一事件的事件链。&#34;&#34;&#34;
    yield event


class AbstractEventBus():
    &#34;&#34;&#34;抽象事件总线。

    事件总线的基类。
    &#34;&#34;&#34;
    @abc.abstractmethod
    def subscribe(self, event, func: Callable, priority: int = 0) -&gt; None:
        &#34;&#34;&#34;注册事件处理器。

        Args:
            event: 事件名。
            func: 事件处理器。
            priority: 优先级，小者优先。
        &#34;&#34;&#34;

    @abc.abstractmethod
    def unsubscribe(self, event, func: Callable) -&gt; None:
        &#34;&#34;&#34;移除事件处理器。

        Args:
            event: 事件名。
            func: 事件处理器。
        &#34;&#34;&#34;

    @abc.abstractmethod
    def on(self, event, priority: int = 0) -&gt; Callable:
        &#34;&#34;&#34;以装饰器的方式注册事件处理器。

        例如：
        ```py
        @bus.on(&#39;Event.MyEvent&#39;)
        def my_event_handler(event):
            print(event)
        ```

        Args:
            event: 事件名。
            priority: 优先级，小者优先。
        &#34;&#34;&#34;

    @abc.abstractmethod
    async def emit(self, event, *args, **kwargs) -&gt; List[Awaitable[Any]]:
        &#34;&#34;&#34;触发一个事件。

        异步执行说明：`await emit` 时执行事件处理器，所有事件处理器执行完后，并行运行所有快速响应。

        Args:
            event: 要触发的事件名称。
            *args: 传递给事件处理器的参数。
            **kwargs: 传递给事件处理器的参数。

        Returns:
            List[Awaitable[Any]]: 所有事件处理器的快速响应协程的 Task。
        &#34;&#34;&#34;


class EventBus(AbstractEventBus):
    &#34;&#34;&#34;事件总线。

    事件总线提供了一个简单的方法，用于分发事件。事件处理器可以通过 `subscribe` 或 `on` 注册事件，
    并通过 `emit` 来触发事件。

    事件链（Event Chain）是一种特殊的事件处理机制。事件链包含一系列事件，其中底层事件触发时，上层事件也会响应。

    事件总线的构造函数中的 `event_chain_generator` 参数规定了生成事件链的方式。
    此模块中的 `event_chain_single` 和 `event_chain_separator` 可应用于此参数，分别生成单一事件的事件链和按照分隔符划分的事件链。
    &#34;&#34;&#34;
    def __init__(
        self,
        event_chain_generator: Callable[[str],
                                        Iterable[str]] = event_chain_single,
    ):
        &#34;&#34;&#34;
        Args:
            event_chain_generator: 一个函数，
                输入事件名，返回一个生成此事件所在事件链的全部事件的事件名的生成器，
                默认行为是事件链只包含单一事件。
        &#34;&#34;&#34;
        self._subscribers: Dict[
            str, PriorityDict[Callable]] = defaultdict(PriorityDict)
        self.event_chain_generator = event_chain_generator

    def subscribe(self, event: str, func: Callable, priority: int = 0) -&gt; None:
        &#34;&#34;&#34;注册事件处理器。

        Args:
            event: 事件名。
            func: 事件处理器。
            priority: 优先级，小者优先。
        &#34;&#34;&#34;
        self._subscribers[event].add(priority, func)

    def unsubscribe(self, event: str, func: Callable) -&gt; None:
        &#34;&#34;&#34;移除事件处理器。

        Args:
            event: 事件名。
            func: 事件处理器。
        &#34;&#34;&#34;
        try:
            self._subscribers[event].remove(func)
        except KeyError:
            logger.warning(f&#39;试图移除事件 `{event}` 的一个不存在的事件处理器 `{func}`。&#39;)

    def on(self, event: str, priority: int = 0) -&gt; Callable:
        &#34;&#34;&#34;以装饰器的方式注册事件处理器。

        例如：
        ```py
        @bus.on(&#39;Event.MyEvent&#39;)
        def my_event_handler(event):
            print(event)
        ```

        Args:
            event: 事件名。
            priority: 优先级，小者优先。
        &#34;&#34;&#34;
        def decorator(func: Callable) -&gt; Callable:
            self.subscribe(event, func, priority)
            return func

        return decorator

    async def emit(self, event: str, *args, **kwargs) -&gt; List[Awaitable[Any]]:
        &#34;&#34;&#34;触发一个事件。

        异步执行说明：`await emit` 时执行事件处理器，所有事件处理器执行完后，并行运行所有快速响应。

        Args:
            event: 要触发的事件名称。
            *args: 传递给事件处理器的参数。
            **kwargs: 传递给事件处理器的参数。

        Returns:
            List[Awaitable[Any]]: 所有事件处理器的快速响应协程的 Task。
        &#34;&#34;&#34;
        async def call(f) -&gt; Optional[Awaitable[Any]]:
            result = await async_with_exception(f(*args, **kwargs))
            # 快速响应：如果事件处理器返回一个协程，那么立即运行这个协程。
            if inspect.isawaitable(result):
                return async_with_exception(result)
            # 当不使用快速响应时，返回值无意义。
            return None

        coros: List[Optional[Awaitable[Any]]] = []
        try:
            for m_event in self.event_chain_generator(event):
                try:
                    # 使用 list 避免 _subscribers 被改变引起错误。
                    for listeners in list(self._subscribers[m_event]):
                        try:
                            # noinspection PyTypeChecker
                            callee = (call(f) for f in listeners)
                            coros += await asyncio.gather(*callee)
                        except SkipExecution:
                            continue
                except StopExecution:
                    continue
        except StopPropagation:
            pass

        # 只保留快速响应的返回值。
        return [asyncio.create_task(coro) for coro in filter(None, coros)]


__all__ = [
    &#39;AbstractEventBus&#39;, &#39;EventBus&#39;, &#39;event_chain_separator&#39;,
    &#39;event_chain_single&#39;
]</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="mirai.bus.event_chain_separator"><code class="name flex">
<span>def <span class="ident">event_chain_separator</span></span>(<span>sep: str = '.')</span>
</code></dt>
<dd>
<div class="desc"><p>按照分隔符划分事件链，默认按点号划分。</p>
<p>例如使用 <code>event_chain_separator('.')</code> 时，
<code>"Event.MyEvent"</code> 所在事件链为 <code>["Event.MyEvent", "Event"]</code>。</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def event_chain_separator(sep: str = &#39;.&#39;):
    &#34;&#34;&#34;按照分隔符划分事件链，默认按点号划分。

    例如使用 `event_chain_separator(&#39;.&#39;)` 时，
    `&#34;Event.MyEvent&#34;` 所在事件链为 `[&#34;Event.MyEvent&#34;, &#34;Event&#34;]`。&#34;&#34;&#34;
    def generator(event: str):
        while True:
            yield event
            event, *sub_event = event.rsplit(sep, maxsplit=1)  # 由下到上依次触发
            if not sub_event:  # 顶层事件触发完成
                break

    return generator</code></pre>
</details>
</dd>
<dt id="mirai.bus.event_chain_single"><code class="name flex">
<span>def <span class="ident">event_chain_single</span></span>(<span>event: str)</span>
</code></dt>
<dd>
<div class="desc"><p>只包含单一事件的事件链。</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def event_chain_single(event: str):
    &#34;&#34;&#34;只包含单一事件的事件链。&#34;&#34;&#34;
    yield event</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="mirai.bus.AbstractEventBus"><code class="flex name class">
<span>class <span class="ident">AbstractEventBus</span></span>
</code></dt>
<dd>
<div class="desc"><p>抽象事件总线。</p>
<p>事件总线的基类。</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class AbstractEventBus():
    &#34;&#34;&#34;抽象事件总线。

    事件总线的基类。
    &#34;&#34;&#34;
    @abc.abstractmethod
    def subscribe(self, event, func: Callable, priority: int = 0) -&gt; None:
        &#34;&#34;&#34;注册事件处理器。

        Args:
            event: 事件名。
            func: 事件处理器。
            priority: 优先级，小者优先。
        &#34;&#34;&#34;

    @abc.abstractmethod
    def unsubscribe(self, event, func: Callable) -&gt; None:
        &#34;&#34;&#34;移除事件处理器。

        Args:
            event: 事件名。
            func: 事件处理器。
        &#34;&#34;&#34;

    @abc.abstractmethod
    def on(self, event, priority: int = 0) -&gt; Callable:
        &#34;&#34;&#34;以装饰器的方式注册事件处理器。

        例如：
        ```py
        @bus.on(&#39;Event.MyEvent&#39;)
        def my_event_handler(event):
            print(event)
        ```

        Args:
            event: 事件名。
            priority: 优先级，小者优先。
        &#34;&#34;&#34;

    @abc.abstractmethod
    async def emit(self, event, *args, **kwargs) -&gt; List[Awaitable[Any]]:
        &#34;&#34;&#34;触发一个事件。

        异步执行说明：`await emit` 时执行事件处理器，所有事件处理器执行完后，并行运行所有快速响应。

        Args:
            event: 要触发的事件名称。
            *args: 传递给事件处理器的参数。
            **kwargs: 传递给事件处理器的参数。

        Returns:
            List[Awaitable[Any]]: 所有事件处理器的快速响应协程的 Task。
        &#34;&#34;&#34;</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="mirai.bot.SimpleMirai" href="bot.html#mirai.bot.SimpleMirai">SimpleMirai</a></li>
<li><a title="mirai.bus.EventBus" href="#mirai.bus.EventBus">EventBus</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="mirai.bus.AbstractEventBus.emit"><code class="name flex">
<span>async def <span class="ident">emit</span></span>(<span>self, event, *args, **kwargs) ‑> List[Awaitable[Any]]</span>
</code></dt>
<dd>
<div class="desc"><p>触发一个事件。</p>
<p>异步执行说明：<code>await emit</code> 时执行事件处理器，所有事件处理器执行完后，并行运行所有快速响应。</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>event</code></strong></dt>
<dd>要触发的事件名称。</dd>
<dt><strong><code>*args</code></strong></dt>
<dd>传递给事件处理器的参数。</dd>
<dt><strong><code>**kwargs</code></strong></dt>
<dd>传递给事件处理器的参数。</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>List[Awaitable[Any]]</code></dt>
<dd>所有事件处理器的快速响应协程的 Task。</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abc.abstractmethod
async def emit(self, event, *args, **kwargs) -&gt; List[Awaitable[Any]]:
    &#34;&#34;&#34;触发一个事件。

    异步执行说明：`await emit` 时执行事件处理器，所有事件处理器执行完后，并行运行所有快速响应。

    Args:
        event: 要触发的事件名称。
        *args: 传递给事件处理器的参数。
        **kwargs: 传递给事件处理器的参数。

    Returns:
        List[Awaitable[Any]]: 所有事件处理器的快速响应协程的 Task。
    &#34;&#34;&#34;</code></pre>
</details>
</dd>
<dt id="mirai.bus.AbstractEventBus.on"><code class="name flex">
<span>def <span class="ident">on</span></span>(<span>self, event, priority: int = 0) ‑> Callable</span>
</code></dt>
<dd>
<div class="desc"><p>以装饰器的方式注册事件处理器。</p>
<p>例如：</p>
<pre><code class="language-py">@bus.on('Event.MyEvent')
def my_event_handler(event):
    print(event)
</code></pre>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>event</code></strong></dt>
<dd>事件名。</dd>
<dt><strong><code>priority</code></strong></dt>
<dd>优先级，小者优先。</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abc.abstractmethod
def on(self, event, priority: int = 0) -&gt; Callable:
    &#34;&#34;&#34;以装饰器的方式注册事件处理器。

    例如：
    ```py
    @bus.on(&#39;Event.MyEvent&#39;)
    def my_event_handler(event):
        print(event)
    ```

    Args:
        event: 事件名。
        priority: 优先级，小者优先。
    &#34;&#34;&#34;</code></pre>
</details>
</dd>
<dt id="mirai.bus.AbstractEventBus.subscribe"><code class="name flex">
<span>def <span class="ident">subscribe</span></span>(<span>self, event, func: Callable, priority: int = 0) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"><p>注册事件处理器。</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>event</code></strong></dt>
<dd>事件名。</dd>
<dt><strong><code>func</code></strong></dt>
<dd>事件处理器。</dd>
<dt><strong><code>priority</code></strong></dt>
<dd>优先级，小者优先。</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abc.abstractmethod
def subscribe(self, event, func: Callable, priority: int = 0) -&gt; None:
    &#34;&#34;&#34;注册事件处理器。

    Args:
        event: 事件名。
        func: 事件处理器。
        priority: 优先级，小者优先。
    &#34;&#34;&#34;</code></pre>
</details>
</dd>
<dt id="mirai.bus.AbstractEventBus.unsubscribe"><code class="name flex">
<span>def <span class="ident">unsubscribe</span></span>(<span>self, event, func: Callable) ‑> NoneType</span>
</code></dt>
<dd>
<div class="desc"><p>移除事件处理器。</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>event</code></strong></dt>
<dd>事件名。</dd>
<dt><strong><code>func</code></strong></dt>
<dd>事件处理器。</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@abc.abstractmethod
def unsubscribe(self, event, func: Callable) -&gt; None:
    &#34;&#34;&#34;移除事件处理器。

    Args:
        event: 事件名。
        func: 事件处理器。
    &#34;&#34;&#34;</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="mirai.bus.EventBus"><code class="flex name class">
<span>class <span class="ident">EventBus</span></span>
<span>(</span><span>event_chain_generator: Callable[[str], Iterable[str]] = &lt;function event_chain_single&gt;)</span>
</code></dt>
<dd>
<div class="desc"><p>事件总线。</p>
<p>事件总线提供了一个简单的方法，用于分发事件。事件处理器可以通过 <code>subscribe</code> 或 <code>on</code> 注册事件，
并通过 <code>emit</code> 来触发事件。</p>
<p>事件链（Event Chain）是一种特殊的事件处理机制。事件链包含一系列事件，其中底层事件触发时，上层事件也会响应。</p>
<p>事件总线的构造函数中的 <code>event_chain_generator</code> 参数规定了生成事件链的方式。
此模块中的 <code><a title="mirai.bus.event_chain_single" href="#mirai.bus.event_chain_single">event_chain_single()</a></code> 和 <code><a title="mirai.bus.event_chain_separator" href="#mirai.bus.event_chain_separator">event_chain_separator()</a></code> 可应用于此参数，分别生成单一事件的事件链和按照分隔符划分的事件链。</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>event_chain_generator</code></strong></dt>
<dd>一个函数，
输入事件名，返回一个生成此事件所在事件链的全部事件的事件名的生成器，
默认行为是事件链只包含单一事件。</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class EventBus(AbstractEventBus):
    &#34;&#34;&#34;事件总线。

    事件总线提供了一个简单的方法，用于分发事件。事件处理器可以通过 `subscribe` 或 `on` 注册事件，
    并通过 `emit` 来触发事件。

    事件链（Event Chain）是一种特殊的事件处理机制。事件链包含一系列事件，其中底层事件触发时，上层事件也会响应。

    事件总线的构造函数中的 `event_chain_generator` 参数规定了生成事件链的方式。
    此模块中的 `event_chain_single` 和 `event_chain_separator` 可应用于此参数，分别生成单一事件的事件链和按照分隔符划分的事件链。
    &#34;&#34;&#34;
    def __init__(
        self,
        event_chain_generator: Callable[[str],
                                        Iterable[str]] = event_chain_single,
    ):
        &#34;&#34;&#34;
        Args:
            event_chain_generator: 一个函数，
                输入事件名，返回一个生成此事件所在事件链的全部事件的事件名的生成器，
                默认行为是事件链只包含单一事件。
        &#34;&#34;&#34;
        self._subscribers: Dict[
            str, PriorityDict[Callable]] = defaultdict(PriorityDict)
        self.event_chain_generator = event_chain_generator

    def subscribe(self, event: str, func: Callable, priority: int = 0) -&gt; None:
        &#34;&#34;&#34;注册事件处理器。

        Args:
            event: 事件名。
            func: 事件处理器。
            priority: 优先级，小者优先。
        &#34;&#34;&#34;
        self._subscribers[event].add(priority, func)

    def unsubscribe(self, event: str, func: Callable) -&gt; None:
        &#34;&#34;&#34;移除事件处理器。

        Args:
            event: 事件名。
            func: 事件处理器。
        &#34;&#34;&#34;
        try:
            self._subscribers[event].remove(func)
        except KeyError:
            logger.warning(f&#39;试图移除事件 `{event}` 的一个不存在的事件处理器 `{func}`。&#39;)

    def on(self, event: str, priority: int = 0) -&gt; Callable:
        &#34;&#34;&#34;以装饰器的方式注册事件处理器。

        例如：
        ```py
        @bus.on(&#39;Event.MyEvent&#39;)
        def my_event_handler(event):
            print(event)
        ```

        Args:
            event: 事件名。
            priority: 优先级，小者优先。
        &#34;&#34;&#34;
        def decorator(func: Callable) -&gt; Callable:
            self.subscribe(event, func, priority)
            return func

        return decorator

    async def emit(self, event: str, *args, **kwargs) -&gt; List[Awaitable[Any]]:
        &#34;&#34;&#34;触发一个事件。

        异步执行说明：`await emit` 时执行事件处理器，所有事件处理器执行完后，并行运行所有快速响应。

        Args:
            event: 要触发的事件名称。
            *args: 传递给事件处理器的参数。
            **kwargs: 传递给事件处理器的参数。

        Returns:
            List[Awaitable[Any]]: 所有事件处理器的快速响应协程的 Task。
        &#34;&#34;&#34;
        async def call(f) -&gt; Optional[Awaitable[Any]]:
            result = await async_with_exception(f(*args, **kwargs))
            # 快速响应：如果事件处理器返回一个协程，那么立即运行这个协程。
            if inspect.isawaitable(result):
                return async_with_exception(result)
            # 当不使用快速响应时，返回值无意义。
            return None

        coros: List[Optional[Awaitable[Any]]] = []
        try:
            for m_event in self.event_chain_generator(event):
                try:
                    # 使用 list 避免 _subscribers 被改变引起错误。
                    for listeners in list(self._subscribers[m_event]):
                        try:
                            # noinspection PyTypeChecker
                            callee = (call(f) for f in listeners)
                            coros += await asyncio.gather(*callee)
                        except SkipExecution:
                            continue
                except StopExecution:
                    continue
        except StopPropagation:
            pass

        # 只保留快速响应的返回值。
        return [asyncio.create_task(coro) for coro in filter(None, coros)]</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="mirai.bus.AbstractEventBus" href="#mirai.bus.AbstractEventBus">AbstractEventBus</a></li>
</ul>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="mirai.models.bus.ModelEventBus" href="models/bus.html#mirai.models.bus.ModelEventBus">ModelEventBus</a></li>
</ul>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="mirai.bus.AbstractEventBus" href="#mirai.bus.AbstractEventBus">AbstractEventBus</a></b></code>:
<ul class="hlist">
<li><code><a title="mirai.bus.AbstractEventBus.emit" href="#mirai.bus.AbstractEventBus.emit">emit</a></code></li>
<li><code><a title="mirai.bus.AbstractEventBus.on" href="#mirai.bus.AbstractEventBus.on">on</a></code></li>
<li><code><a title="mirai.bus.AbstractEventBus.subscribe" href="#mirai.bus.AbstractEventBus.subscribe">subscribe</a></code></li>
<li><code><a title="mirai.bus.AbstractEventBus.unsubscribe" href="#mirai.bus.AbstractEventBus.unsubscribe">unsubscribe</a></code></li>
</ul>
</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="mirai" href="index.html">mirai</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="mirai.bus.event_chain_separator" href="#mirai.bus.event_chain_separator">event_chain_separator</a></code></li>
<li><code><a title="mirai.bus.event_chain_single" href="#mirai.bus.event_chain_single">event_chain_single</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="mirai.bus.AbstractEventBus" href="#mirai.bus.AbstractEventBus">AbstractEventBus</a></code></h4>
<ul class="">
<li><code><a title="mirai.bus.AbstractEventBus.emit" href="#mirai.bus.AbstractEventBus.emit">emit</a></code></li>
<li><code><a title="mirai.bus.AbstractEventBus.on" href="#mirai.bus.AbstractEventBus.on">on</a></code></li>
<li><code><a title="mirai.bus.AbstractEventBus.subscribe" href="#mirai.bus.AbstractEventBus.subscribe">subscribe</a></code></li>
<li><code><a title="mirai.bus.AbstractEventBus.unsubscribe" href="#mirai.bus.AbstractEventBus.unsubscribe">unsubscribe</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="mirai.bus.EventBus" href="#mirai.bus.EventBus">EventBus</a></code></h4>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>